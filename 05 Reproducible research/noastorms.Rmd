---
title: "NOAA storm event impact analysis"
author: "Kirill Setdekov"
date: "February 27, 2019"
output: html_document
---

## Synopsis
Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Processing 
### Load libraries
```{r}
library(ggplot2)
library(dplyr)
library(reshape2)
library(usmap)
```


### Data loading
We cache the calculation and load the link and directrly read it into R.
```{r cache=TRUE}
link="https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
download.file(link, "data/noaa.bz2")
noaa <- read.csv(bzfile("data/noaa.bz2"))
```
To plot data we need to summarize on an event type level damage
```{r}
damages <- noaa %>% group_by(EVTYPE) %>% summarise(property=sum(PROPDMG), crop=sum(CROPDMG), total=sum(PROPDMG+CROPDMG))
damages <- damages[order(-damages$total),]
damages$EVTYPE <- factor(damages$EVTYPE, levels = damages$EVTYPE[order(-damages$total)])
damages_long <- melt(damages[1:10,c(1,2:3)], id = "EVTYPE")
damages_long$EVTYPE <- droplevels(damages_long$EVTYPE)
ggplot(data = damages_long, aes(x= EVTYPE, y = value ,
                fill=variable)) +
  geom_bar(stat = "identity")+ ylab("Total property damage")+labs(fill="Total damage breakdown", title = "10 disaster types sorted by total damage for all states")+theme_bw()+theme(axis.text.x = element_text(angle = 90, hjust = 1))

people <- noaa %>% group_by(EVTYPE) %>% summarise(injuries=sum(INJURIES), fatalities=sum(FATALITIES), total=sum(INJURIES+FATALITIES))
people <- people[order(-people$total),]
people$EVTYPE <- factor(people$EVTYPE, levels = people$EVTYPE[order(-people$fatalities)])
people_long <- melt(people[1:10,c(1,2:3)], id = "EVTYPE")
people_long$EVTYPE <- droplevels(people_long$EVTYPE)
ggplot(data = people_long, aes(x= EVTYPE, y = value ,
                fill=variable)) +
  geom_bar(stat = "identity")+ ylab("People count")+labs(fill="Total death+injury", title = "10 disaster types sorted by fatalities for all states")+theme_bw()+theme(axis.text.x = element_text(angle = 90, hjust = 1))




noaa %>% group_by(EVTYPE) %>% summarise(injuries=sum(INJURIES), fatalities=sum(FATALITIES), total=sum(INJURIES+FATALITIES))

temp <- noaa  %>% group_by(STATE,EVTYPE) %>% summarise(FATALITIES = sum(FATALITIES)) %>% filter(FATALITIES == max(FATALITIES))%>% top_n(n=1, FATALITIES)%>%slice(1)


randompop <- statepop
## allocate the most important event here
randompop<- left_join(randompop,temp,by = c("abbr" = "STATE"))
randompop$EVTYPE <- as.character(randompop$EVTYPE ) 

bystates <- (randompop%>%group_by(EVTYPE)%>%summarise(sum=sum(FATALITIES)))
randompop$EVTYPE <- factor(randompop$EVTYPE, levels = bystates$EVTYPE[order(-bystates$sum)])
```

``` {r echo = FALSE, fig.width = 14, fig.height = 9, out.width = "1026", out.height = "528"}
# plot
plot_usmap(data = randompop, values = "EVTYPE") + 
  labs(title = "US States", subtitle = "most deadly event for each state") + 
  theme(panel.background = element_rect(colour = "black", fill = "lightblue"))


```



The analysis document must have at *least one* figure containing a plot.

Your analysis must have no *more than three* figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.


## Results 


#Assignment
The basic goal of this assignment is to explore the NOAA Storm Database and answer some basic questions about severe weather events. You must use the database to answer the questions below and show the code for your entire analysis. Your analysis can consist of tables, figures, or other summaries. You may use any R package you want to support your analysis.

##Questions
Your data analysis must address the following questions:

Across the United States, which types of events (as indicated in the \color{red}{\verb|EVTYPE|}EVTYPE variable) are most harmful with respect to population health?

Across the United States, which types of events have the greatest economic consequences?

Consider writing your report as if it were to be read by a government or municipal manager who might be responsible for preparing for severe weather events and will need to prioritize resources for different types of events. However, there is no need to make any specific recommendations in your report.


# review criteria

Has either a (1) valid RPubs URL pointing to a data analysis document for this assignment been submitted; or (2) a complete PDF file presenting the data analysis been uploaded?

Does the analysis include description and justification for any data transformations?

Does the document have a title that briefly summarizes the data analysis?

Does the document have a synopsis that describes and summarizes the data analysis in less than 10 sentences?

Is there a section titled "Data Processing" that describes how the data were loaded into R and processed for analysis?

Is there a section titled "Results" where the main results are presented?

Is there at least one figure in the document that contains a plot?

Are there at most 3 figures in this document?

Does the analysis start from the raw data file (i.e. the original .csv.bz2 file)?

Does the analysis address the question of which types of events are most harmful to population health?

Does the analysis address the question of which types of events have the greatest economic consequences?

Do all the results of the analysis (i.e. figures, tables, numerical summaries) appear to be reproducible?

Do the figure(s) have descriptive captions (i.e. there is a description near the figure of what is happening in the figure)?

As far as you can determine, does it appear that the work submitted for this project is the work of the student who submitted it?
