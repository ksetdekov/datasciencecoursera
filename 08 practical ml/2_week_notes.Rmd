---
title: "Practical machine learning  lectures 2"
author: "Kirill Setdekov"
date: "October 05 2019"
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	cache = TRUE
)
```

# week 2

Caret package

## additional materisl


* Caret tutorials:
    * [http://www.edii.uclm.es/~useR-2013/Tutorials/kuhn/user_caret_2up.pdf](http://www.edii.uclm.es/~useR-2013/Tutorials/kuhn/user_caret_2up.pdf)
    * [https://cran.r-project.org/web/packages/caret/vignettes/caret.html](https://cran.r-project.org/web/packages/caret/vignettes/caret.html)
* A paper introducing the caret package
    * [http://www.jstatsoft.org/v28/i05/paper](http://www.jstatsoft.org/v28/i05/paper)

```{r caret}
require(caret)
```

Functionality

* cleaning
    * preProcess
* data splitting
    * createDataPartition
    * createResample
    * createTimeSlices
* trainign/testing functionality
    * train
    * predict
* model comparison
    * confusionMatrix
```{r spamsplit}
require(kernlab)
data(spam)
intrain <- createDataPartition(y = spam$type, p = 0.75, list = FALSE)
training <- spam[intrain, ]
testing <- spam[-intrain, ]
dim(training)

#fit a model
set.seed(32343)
modelFit <- train(type ~ ., data = training, method = "glm")
modelFit

#results
modelFit$finalModel

#predict
prediction <- predict(modelFit, newdata = testing)
head(prediction)
table(prediction)

#confusionmatrix
confusionMatrix(prediction, testing$type)
```

```{r dataslicing_kfold}
require(kernlab)
data(spam)
intrain <- createDataPartition(y = spam$type, p = 0.75, list = FALSE)
training <- spam[intrain, ]
testing <- spam[-intrain, ]
dim(training)

fold <- createFolds(y=spam$type, k=10, list = TRUE, returnTrain = TRUE)
sapply(fold, length)

#return only testing
fold <- createFolds(y=spam$type, k=10, list = TRUE, returnTrain = FALSE)
sapply(fold, length)

#doing resampling the whole set
fold <- createResample(y=spam$type, times=10, list = TRUE)
sapply(fold, length)


# time clices
tme <- 1:1000
folds <- createTimeSlices(y=tme,initialWindow = 20, horizon = 10)
names(folds)
folds$train[[1]]
```

### Training options
Spam example
```{r trainingcontrolspam}
require(caret)
require(kernlab)
data(spam)

intrain <- createDataPartition(y=spam$type, p=0.75, list = FALSE)
training <- spam[intrain,]
testing <- spam[-intrain,]
modelFit <- train(type~., data = training, method ="glm")

#results
modelFit$finalModel

#predict
prediction <- predict(modelFit, newdata = testing)
head(prediction)
table(prediction)

#confusionmatrix
confusionMatrix(prediction, testing$type)

# accuracy to Kappa
modelFit <- train(type~., data = training, method ="glm", metric = "Kappa")
prediction2 <- predict(modelFit, newdata = testing)
confusionMatrix(prediction2, testing$type)



```

Metric options
* Continuous
    * RMSE
    * R^2
* categorical
    * accuracy
    * Kappa
    
```{r}
args(trainControl)
control <- trainControl(number = 100)
modelFit <- train(type~., data = training, method ="glm", trControl=control)
prediction <- predict(modelFit, newdata = testing)
confusionMatrix(prediction, testing$type)
```
Method

* boot bootstrap
* boot632 bootstrap  with adjustment
* cv cross validation
* repeatedcv = repeated cross validation
* loocv = leave one out cross validation

number - usefull for many parameters
 
* for boot/cross validaiton
* number of subsaples to take

repears

* number of times to repaea subsampling
* if big this can slow things down a lot

```{r}
control <- trainControl(method = "cv")
modelFit <- train(type~., data = training, method ="glm", trControl=control)
prediction <- predict(modelFit, newdata = testing)
confusionMatrix(prediction, testing$type)
```
Usefull to set a seed.

```{r setseedresult}
set.seed(1235)
modelFit3 <- train(type~., data=training, method="glm")
modelFit3
```

# plotting predicitons

Wage data
```{r wages}
library(ISLR)
require(ggplot2)
require(caret)
require(GGally)
require(dplyr)
data(Wage)
summary(Wage)

pairs(Wage)
Wage %>% select(age, race, wage, education) %>% ggpairs(., lower = list(continuous = wrap("smooth", alpha = 0.3, size=0.1)))

#set adide testing set
intrain <- createDataPartition(y=Wage$wage, p=0.7, list = FALSE)
training <- Wage[intrain,]
testin <- Wage[-intrain,]
dim(training)
dim(testin)
```

## Feature plot ::caret
```{r plots}
featurePlot(x = training[,c("age","race", "education")], y = training$wage, plot = "pairs")

qplot(age, wage, colour = education,data = training)+geom_smooth(method = 'lm', formula = y~x)
```

```{r cut}
require(Hmisc)
cutwage <- cut2(training$wage, g=3)
table(cutwage)

cbind.data.frame(cutwage,training %>% select(race)) %>% ggpairs(., lower = list(continuous = wrap("smooth", alpha = 0.3, size=0.1)))
cbind.data.frame(cutwage,training %>% select(race)) %>% table

qplot(cutwage, age, data = training, fill = cutwage, geom = c("violin"))

qplot(cutwage, age, data = training, fill = cutwage, geom = c("boxplot"))

qplot(race, wage, data = training, fill = education, geom = c("boxplot"))


```


